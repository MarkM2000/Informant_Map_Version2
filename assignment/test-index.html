<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title>title</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
    integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous" />
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
    integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,400;0,800;1,800&display=swap"
    rel="stylesheet" />
  <style>
    body {
      background: #20282e;
      font-family: "Open Sans", sans-serif;
      font-weight: 400;
      font-size: 100%;
    }

    footer {
      position: fixed;
      bottom: 0;
      width: 100%;
      height: 3rem;
    }

    h1 {
      font-weight: 800;
    }

    p {
      line-height: 1.7rem;
    }

    #map {
      /* height is set in JS */
      background: #2d2f31;
    }

    .legend {
      font-size: 1rem;
      border-radius: 5px;
      max-width: 200px;
      font-family: "Open Sans", sans-serif;
      background: rgba(100, 100, 100, 0.9);
      color: rgba(244, 244, 244, 0.8);
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
    }

    .legend h3 {
      font-size: 1.1em;
      font-weight: normal;
      color: #ddd;
      margin: 0 0 10px 0;
    }

    .legend span {
      width: 20px;
      height: 20px;
      margin: 0 10px 4px 0;
    }

    .legend label {
      font-size: 0.9rem;
    }

    .leaflet-bar a {
      /* Override the default style for Leaflet's zoom  */
      background: rgba(100, 100, 100, 0.9);
      color: rgba(244, 244, 244, 0.8);
    }

    a:hover {
      color: rgb(130, 131, 132);
      text-decoration: none;
    }

    /* Custom Tool tips */
    .leaflet-tooltip-own {
      background: rgba(58, 58, 58, 0.955);
      color: rgb(244, 244, 244);
      border: none;
      font-size: 1rem;
      border-radius: 5px;
      padding: 10px;
      font-family: "Open Sans", sans-serif;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
    }

    .leaflet-tooltip-left:before {
      right: 0;
      margin-right: -12px;
      border-left-color: rgba(0, 0, 0, 0.4);
    }

    .leaflet-tooltip-right:before {
      left: 0;
      margin-left: -12px;
      border-right-color: rgba(0, 0, 0, 0.4);
    }

    /* Small devices (landscape phones, 576px and up) */
    @media (min-width: 576px) {}

    /* Medium devices (tablets, 768px and up) */
    @media (min-width: 768px) {}

    /* Large devices (desktops, 992px and up) */
    @media (min-width: 992px) {}

    /* Extra large devices (large desktops, 1200px and up) */
    @media (min-width: 1200px) {}
  </style>
</head>

<body>
  <div class="container-fluid">
    <header class="row bg-dark text-white p-2">
      <div class="col-8">
        <h1>Map title</h1>
      </div>
      <div class="col-4 align-self-center">
        <p class="d-flex justify-content-end my-auto">
          <a class="btn btn-primary" data-bs-toggle="offcanvas" href="#offcanvasExample" role="button"
            aria-controls="offcanvasExample">
            Map Info
          </a>
        </p>
      </div>
    </header>

    <section class="row">
      <div class="p-0">
        <div id="map"></div>
      </div>
    </section>

    <footer class="row bg-dark text-white p-2">
      <p class="text-center"></p>
    </footer>
  </div>

  <div class="offcanvas offcanvas-start bg-dark text-white" tabindex="-1" id="offcanvasExample"
    aria-labelledby="offcanvasExampleLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="offcanvasExampleLabel">Map Info</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <h3 class="py-2">ACS Ownership Rates by County, 2020</h3>
      <p>
        This map will be a American Community Survey that will involve finding the ownership rates by county in the
        United States. This map will include a blue color joined layer pattern and the counties with darker color will
        show the most amount of ownership ratings in each county.
      </p>
      <hr />
      <ul class="list-unstyled">
        <li>Authored by Mark Marji</li>
        <li>January 16, 2024</li>
        <li>Data source: <a
            href="https://api.census.gov/data/2020/acs/acs5/profile?get=NAME,DP04_0001E,DP04_0002E,DP04_0003E,DP04_0046E,DP04_0091E,DP04_0092E,DP04_0126E&for=county">Link</a>
        </li>
      </ul>
    </div>
  </div>

  <!-- legend is outside of container-fluid and will be dynamically added to map -->
<div class="legend d-flex flex-column px-3 py-2" id="legend"></div>


  <!-- ui is outside of container-fluid and will be dynamically added to map -->
  <div class="form-group me-3 mt-3" id="dropdown-ui">
    <select class="form-control bg-primary text-white">
      <option value="DP04_0091E">Owner occupied units with a mortgage or loan</option>
      <option value="DP04_0092E">Occupied units owned free and clear"</option>
      <option value="DP04_0126E">Number of units occupied by a renter</option>
    </select>
  </div>
  <!-- end ui-controls -->

  <!-- Add Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
    crossorigin="anonymous"></script>
  <!-- then Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
    integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
  <!-- then Simple Statistics -->
  <script src="https://unpkg.com/simple-statistics@7.8.3/dist/simple-statistics.min.js"></script>
  <script>
    // Add footer date
    setDate()

    // set global variables for header, map container, and footer
    const header = document.querySelector("header");
    const mapContainer = document.querySelector("#map");
    const footer = document.querySelector("footer");

    // set map height to fill window
    mapContainer.style.height =
      window.innerHeight - header.offsetHeight - footer.offsetHeight + "px";

    // initial Leaflet map options
    const options = {
      center: [37.09024, -95.7],
      zoom: 7.4,
      zoomSnap: 0.1,
      zoomControl: false,
      attributionControl: false,
    };

    // create Leaflet map and apply options
    const map = L.map("map", options);

    // request a basemap tile layer and add to the map
    L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
      attribution:
        '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    }).addTo(map);

    // Example of keeping your page fresh
    function setDate() {
      const date = new Date();
      const year = date.getFullYear();
      const month = date.toLocaleString('default', { month: 'long' });
      const footerText = document.querySelector("footer p");
      footerText.innerHTML = `${month}, ${year} | New Maps Plus`;
    }

    const labels = {
      DP04_0091E: "Owner occupied units with a mortgage or loan",
      DP04_0092E: "Occupied units owned free and clear",
      DP04_0126E: "Number of units occupied by a renter"
    }

    // set global variables for map layer,
    // mapped attribute, and normalizing attribute
    let attributeValue = "DP04_0126E";
    const normValue = "DP04_0002E";

    // Make the call to external data
    fetch("/assignment/acs_counties.geojson")
      .then(function (response) {
        if (response.ok) {
          return response.json();
        } else {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
      })
      .then(function (data) {
        drawMap(data);
        addLegend();
      });

    function drawMap(data) {
      // create Leaflet data layer and add to map
      const counties = L.geoJson(data, {
        // style counties with initial default path options
        style: function (feature) {
          return {
            color: "#20282e",
            weight: 0.7,
            fillOpacity: 1,
            fillColor: "#1f78b4",
          };
        },
        // add hover/touch functionality to each feature layer
        onEachFeature: function (feature, layer) {
          // when mousing over a layer
          layer.on("mouseover", function () {
            // change the stroke color and bring that element to the front
            layer
              .setStyle({
                color: "#ff6e00",
              })
              .bringToFront();
          });

          // on mousing off layer
          layer.on("mouseout", function () {
            // reset the layer style to its original stroke color
            layer.setStyle({
              color: "#20282e",
            });
          });
        },
      }).addTo(map);

      // fit the map's bounds and zoom level using the counties extent
      map.fitBounds(counties.getBounds(), {
        padding: [18, 18], // add padding around counties
        animate: false, // disable animating the zoom
      });

      // addLegend(); // add the legend to the map
      updateMap(counties); // draw the map
      addUi(counties); // add UI controls
    }

    function updateMap(counties) {
      let breaks = getClassBreaks(counties);

      // loop through each county layer to update the color and tooltip info
      counties.eachLayer(function (layer) {
        let props = layer.feature.properties;

        // set the fill color of layer based on its normalized data value
        layer.setStyle({
          fillColor: getColor(props[attributeValue] / props[normValue], breaks),
        });

        // assemble string sequence of info for tooltip (end line break with + operator)
        let tooltipInfo = `<b>${props["NAME"]} County</b></br>
    ${((props[attributeValue] / props[normValue]) * 100).toLocaleString()}%`;

        // bind a tooltip to layer with county-specific information
        layer.bindTooltip(tooltipInfo, {
          // sticky property so tooltip follows the mouse
          sticky: true,
        });
      })

      // update the legend with the current data attribute information
      updateLegend(breaks);
    }

    // Get class breaks in data
    function getClassBreaks(counties) {
      // create empty Array for storing values
      const values = [];

      // loop through all the counties
      counties.eachLayer(function (layer) {
        let value =
          layer.feature.properties[attributeValue] /
          layer.feature.properties[normValue];
        values.push(value); // push the normalized value for each layer into the Array
      });

      // determine similar clusters
      const clusters = ss.ckmeans(values, 5);

      // create an array of the lowest value within each cluster
      const breaks = clusters.map(function (cluster) {
        return [cluster[0], cluster.pop()];
      });

      //return array of arrays, e.g., [[0.24,0.25], [0.26, 0.37], etc]
      return breaks;
    }

    // Get color of county
    function getColor(d, breaks) {
      // function accepts a single normalized data attribute value
      // and uses a series of conditional statements to determine which
      // which color value to return to return to the function caller

      if (d <= breaks[0][1]) {
        return "#f7fbff";
      } else if (d <= breaks[1][1]) {
        return "#c8dcf0";
      } else if (d <= breaks[2][1]) {
        return "#73b2d8";
      } else if (d <= breaks[3][1]) {
        return "#2979b9";
      } else if (d <= breaks[4][1]) {
        return "#1c4e7a";
      }
    }

    // Add legend to map
    function addLegend(breaks) {
      // check your console to verify the breaks array
      console.log(breaks);

      // create a new Leaflet control object, and position it top left
      const legendControl = L.control({ position: "topleft" });

      // when the legend is added to the map
      legendControl.onAdd = function () {
        // select a div element with an id attribute of legend
        const legend = L.DomUtil.get("legend");

        // disable scroll and click/touch on map when on legend
        L.DomEvent.disableScrollPropagation(legend);
        L.DomEvent.disableClickPropagation(legend);

        // return the selection to the method
        return legend;
      };

      // add the empty legend div to the map
      legendControl.addTo(map);

     
    }

    function updateLegend(breaks) {
      // function accepts an array of classification breaks values as
      // a parameter and draws/updates the legend based upon these values
      // select the legend, add a title, begin an unordered list and assign to a variable
       // select the legend, add a title, begin an unordered list and assign to a variable
       const legend = document.querySelector("#legend")
      legend.innerHTML = `<h5>${labels[attributeValue]}</h5>`;

      // loop through the Array of classification break values
      for (let i = 0; i <= breaks.length - 1; i++) {
        let color = getColor(breaks[i][0], breaks);

        legend.innerHTML +=
          `<div class="d-flex flex-row justify-content-start">
          <span style="background:${color}"></span>
          <label>${(breaks[i][0] * 100).toFixed(1)} &mdash; 
          ${(breaks[i][1] * 100).toFixed(1)}%</label>
      </div>`
      }
    }

    function addUi(counties) {
        // create the slider control
        var selectControl = L.control({ position: "topright" });

        // when control is added
        selectControl.onAdd = function () {
          // get the element with id attribute of ui-controls
          return L.DomUtil.get("dropdown-ui");
        };
        // add the control to the map
        selectControl.addTo(map);

        const leg = document.querySelector("#dropdown-ui select")
        console.log(leg);

        leg.addEventListener("change", function (e) {
          console.log(this);
          console.log(e.target);

          attributeValue = e.target.value;

          // update the map
          updateMap(counties);

        });
      }
  

    map.addControl(L.control.zoom({ position: "topright" }));
  </script>
</body>

</html>